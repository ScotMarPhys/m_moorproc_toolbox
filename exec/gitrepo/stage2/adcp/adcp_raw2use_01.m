% function adcp_raw2use_01(moor,'procpath',procpath,'outpath',outpath)%% basic preprocessing for RDI ADCP data% % required inputs: moor - mooring name e.g 'eb3_1_200406'%% optional inputs: procpath - path to proc directory if not using standard%                             paths%                  outpath - path to output processed files to - otherwise%                            outputs to directory function run from%                  plot_interval - matrix of start and end dates for plot%                                  e.g. [2004 02 01 00; 2005 06 01 00]%                                  dates are:- yyyy mm dd hh%% features%      1. eliminate launching and recovery period%      2. save data to rodb file%      3. create data overview sheet%% uses timeaxis.m, auto_filt.m, julian.m, rodbload.m, rodbsave.m%% 10/12/09 - DR modified from dvs_raw2use_01% 19/10/20 - LH fix bug on instrument depth (target depth) which was erased to bin depth indep%function adcp_raw2use_01(moor,varargin)    global MOORPROC_G    basedir = MOORPROC_G.moordatadir;    cruise= MOORPROC_G.cruise;        if nargin==0        help adcp_raw2use_01        return    end        if nargin==1        pd = moor_inoutpaths('adcp',moor);    else        pd = varargin{1};    end        a = find(strcmp('plot_interval', varargin));    if a>0 && ~isempty(varargin{a+1})        plot_interval=reshape(varargin{a+1},4,2)';    else        plot_interval=[];    end        operator = MOORPROC_G.operator;        % ----- read infofile / open logfile  ------------------------------------    infovar = 'instrument:serialnumber:z:Start_Time:Start_Date:End_Time:End_Date:Latitude:Longitude:WaterDepth:Mooring';    [id,sn,z,s_t,s_d,e_t,e_d,lat,lon,wd,mr]  =  rodbload(pd.infofile,infovar);        vec=find((id>=319) & (id <=328)); % Possible ADCP codes - taken from IMP moorings package        sn=sn(vec);    z = z(vec);        fid_stat= fopen(pd.stage2log,'w');    fprintf(fid_stat,['Processing steps taken by ' mfilename ':\n']);    fprintf(fid_stat,'  1. eliminate lauching and recovery period\n');    fprintf(fid_stat,'  2. save data to rodb file\n');    fprintf(fid_stat,'\n Operated by:%s on %s\n',operator,datestr(clock));     fprintf(fid_stat,['        ADCPs in Mooring ',moor,'\n\n\n']);            % Determine plot_interval if not input to function    if isempty(plot_interval)        plot_interval = [s_d(1) s_d(2)-1 s_d(3) 0; e_d(1) e_d(2)+1 e_d(3) 0];        if plot_interval(1,2)==0            plot_interval(1,2)=12; plot_interval(1,1)=plot_interval(1,1)-1;        end        if plot_interval(2,2)==13            plot_interval(2,2)=1; plot_interval(2,1)=plot_interval(2,1)+1;        end    end            %-----------------------------------------    % --- preprocessing loop -------------------    % ----------------------------------------        jd_s = julian([s_d(:)' hms2h([s_t(:)' 0])]); %start    jd_e = julian([e_d(:)' hms2h([e_t(:)' 0])]); %end            %all_z=[combo_z individual_z];    %all_sn=[combo_sn individual_sn];    zADCP = z ;    for proc = 1 : length(vec) % loop for multiple instruments on moooring                % first determine how many bin files are to be processed        % trying to do automatically        num_bins=dir(fullfile(pd.stage1path,...            [sprintf(pd.stage2inform,sn(proc)),'*.raw']));        num_bins=length(num_bins);        clear press_sensor        disp(['ADCP Serial number: ' num2str(sn(proc))])                  indep  = zADCP(proc);                   for j=1:num_bins % loop for total number of bins                        columns = ['YY:MM:DD:HH:Z:T:U:V:W:HDG:PIT:ROL:CS:CD:',...                'BEAM1SS:BEAM2SS:BEAM3SS:BEAM4SS:BEAM1COR:BEAM2COR:',...                'BEAM3COR:BEAM4COR:EV:BEAM1PGP:BEAM2PGP:BEAM3PGP:BEAM4PGP'];                                  infile = fullfile(pd.stage1path,sprintf(pd.stage1form,sn(proc),j));                        if exist(infile,'file')==0                disp(['infile: ' infile ' does not exist.'])                elseif exist(infile,'file')   > 0                                 outfile = fullfile(pd.stage2path,sprintf(pd.stage2form,sn(proc),j));                fprintf(fid_stat,'Serialnumber %d \n',sn(proc));                fprintf(fid_stat,'Bin %d \n',j);                fprintf(fid_stat,'Infile %s \n',infile);                fprintf(fid_stat,'Outfile %s \n',outfile);                                             [YY,MM,DD,HH,z,t,u,v,w,heading,pitch,roll,spd,...                    direction,Amp1,Amp2,Amp3,Amp4,...                    Beam1Cor,Beam2Cor,Beam3Cor,Beam4Cor,err,PG1,PG2,PG3,PG4] = ...                    rodbload(infile,[columns]);                                             %------------------------------------------                 %----- cut off launching and recovery period                %------------------------------------------                disp('cut off launching and recovery period')                    jd  = julian(YY,MM,DD,HH);                ii  = find(jd <= jd_e & jd >= jd_s );                    YY=YY(ii);MM=MM(ii);DD=DD(ii);HH=HH(ii);                u=u(ii);v=v(ii);w=w(ii);                heading=heading(ii);pitch=pitch(ii);roll=roll(ii);                t=t(ii);                Amp1=Amp1(ii);Amp2=Amp2(ii);Amp3=Amp3(ii);Amp4=Amp4(ii);                Beam1Cor=Beam1Cor(ii);Beam2Cor=Beam2Cor(ii);Beam3Cor=Beam3Cor(ii);Beam4Cor=Beam4Cor(ii);                                spd=spd(ii); direction=direction(ii);                    err=err(ii);                PG1=PG1(ii);PG2=PG2(ii);PG3=PG3(ii);PG4=PG4(ii);                z=z(ii);                                jd  = jd(ii);                     cycles     = length(ii);                Start_Date = [YY(1) MM(1) DD(1)];                Start_Time = HH(1);                End_Date = [YY(cycles) MM(cycles) DD(cycles)];                End_Time = HH(cycles);                            %-----------------------------------------------------                %  write output to logfile ---------------------------                %-----------------------------------------------------                    fprintf(fid_stat,'Operation interval: %s  to  %s\n', ...                      datestr(gregorian(jd(1))),datestr(gregorian(jd(end)) ));                fprintf(fid_stat,'\n');                    %-----------------------------------                  %--- write data to rodb format -----                %-----------------------------------                    disp(['writing data to ',outfile])                     fort =['%4.4d %2.2d %2.2d  %6.4f  %4.2f  %4.2f %4.1f %4.1f %4.1f  %4.2f '...                        '%4.2f %4.2f  %4.1f  %4.1f  %3.0f %3.0f %3.0f %3.0f   '...                        '%3.0f %3.0f %3.0f %3.0f  %4.1f  %3.0f %3.0f %3.0f %3.0f'];                data = [YY MM DD HH z t u v w heading pitch roll spd direction ...                        Amp1 Amp2 Amp3 Amp4 Beam1Cor Beam2Cor Beam3Cor Beam4Cor ...                        err PG1 PG2 PG3 PG4];                     rodbsave(outfile,...                  'Latitude:Longitude:Columns:Start_Date:Start_Time:SerialNumber:Mooring:WaterDepth:Instrdepth:End_Date:End_Time',...                   fort,...                  lat,lon,columns,Start_Date,Start_Time,sn(proc),mr,wd,indep,End_Date,End_Time,...                  data);                    %%%%%%%%%% Graphics %%%%%%%%%%%%%%%%                % constants                sampling_rate = 1/median(diff(jd));                jd0 = julian(-1,1,1,24);                x   = jd-jd0;                jd1 = julian(plot_interval(1,:))-jd0;                jd2 = julian(plot_interval(2,:))-jd0;                 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%                % Figure 1: plot vert, merid, zonal vels                figure(1);clf;                ax1=subplot(3,1,1);                                i1    = find(~isnan(u) & u>-3000);                plot(x(i1),u(i1));                hold on; grid on                u_filt=auto_filt(u(i1),sampling_rate,1/2,'low',4);                plot(x(i1),u_filt, 'LineWidth',2);                ylabel('Zonal Velocity [cm/s]'); grid on                legend('data','filtered');                datetick('x','mmm-yy'); axis tight                    ax2=subplot(3,1,2);                                i1    = find(~isnan(v) & v>-3000);                plot(x(i1),v(i1));                hold on; grid on                v_filt=auto_filt(v(i1),sampling_rate,1/2,'low',4);                plot(x(i1),v_filt, 'LineWidth',2);                ylabel('Merid. Velocity [cm/s]');                datetick('x','mmm-yy'); axis tight                legend('data','filtered');                ax3=subplot(3,1,3);                                i1    = find(~isnan(w) & w>-3000);                plot(x(i1),w(i1));                hold on;                w_filt=auto_filt(w(i1),sampling_rate,1/2,'low',4);                plot(x(i1),w_filt, 'LineWidth',2);                ylabel('Vert. Velocity [cm/s]')                grid on                datetick('x','mmm-yy')                axis tight                legend('data','filtered');                suptitle(['ADCP s/n: ',num2str(sn(proc)), ...                     '  Deployment Depth: ',num2str(indep), ...                     'm Bin ',num2str(j)]);                print(figure(1),'-dpng', '-r300',[outfile '_filtered.png']);                % Figure 2                figure(2); clf;                i1    = find(~isnan(v) & v>-3000);                ax(1)=subplot(3,1,1);                plot(x,heading,'r.')  ; grid on                ylabel('Heading [deg]');                     ax(2)=subplot(3,1,2);                plot(x,pitch);                hold on                plot(x,roll);                grid on                ylabel('angle [deg]');                ax(3)=subplot(3,1,3);                plot(x,Amp1);                hold on                plot(x,Amp2);                plot(x,Amp3);                legend('Amp1','Amp2','Amp3');                if exist('Amp4','var')                    plot(x,Amp4);                    legend('Amp1','Amp2','Amp3','Amp4');                end                ylabel('sig. str. [counts]'); grid on                for kk=1:length(ax)                    datetick(ax(kk),'x','mmm yyyy','keeplimits', 'keepticks');                end                print(figure(2),'-dpng', '-r300',[outfile '.png'])                %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%                if j == 1                    % Figure 3: ADCP heaidng, depth, and temperature                    figure(3); clf                    ax(1)=subplot(3,1,1);                    plot(x,heading,'r.')  ; grid on                    ylabel('Heading [deg]');                    ax(2)=subplot(3,1,2);                    plot(x,t,'b-'); grid on;                    ylabel('Temp. at ADCP [deg C]' );                    ax(3)=subplot(3,1,3);                    plot(x,z,'k-'); grid on                    ylabel('Depth [m]');                    suptitle(['ADCP s/n: ',num2str(sn(proc)), ...                         '; Deployment Depth: ',num2str(indep)]);                    for kk=1:length(ax)                        datetick(ax(kk),'x','mmm yyyy','keeplimits', 'keepticks');                    end                    print(figure(3),'-dpng', '-r300',[outfile '_diagnostics.png']);                end            end % if exist(infile)==0        end % loop for different bin depths    end  % for proc=1:length(combo_sn)+length(individual_sn) loopend % function  %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% function ok = plot_timeseries(jd,var1,var2,var3,var4,sr,str,sub,jdlim,filt,panels)% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% % plot time series% % %   jd0 = julian(-1,1,1,24);% %   i1    = find(~isnan(var1) & var1~=0 & var1>-3000);%  %   if strcmp(filt,'y')%     var1  = auto_filt(var1(i1),sr,1/2,'low',4);%   else%     var1  = var1(i1);%   end % %   if ~isempty(var2)%     i2    = find(~isnan(var2) & var2~=0 & var2>-3000);%     if strcmp(filt,'y')%       var2  = auto_filt(var2(i2),sr,1/2,'low',4);%     else%       var2  = var2(i2);%     end%   end%   %   if ~isempty(var3)%     i3    = find(~isnan(var3) & var3~=0 & var3>-3000);%     if strcmp(filt,'y')%         var3  = auto_filt(var3(i3),sr,1/2,'low',4);%     else%         var3  = var3(i3);%     end%  end%   %   if ~isempty(var4)%     i4    = find(~isnan(var4) & var4~=0 & var4>-3000);%     if strcmp(filt,'y')%         var4  = auto_filt(var4(i4),sr,1/2,'low',4);%     else%         var4  = var4(i4);%     end%  end% %   subplot(panels,1,sub);%   %   if ~isempty(var1(~isnan(var1)))       %     plot(jd(i1)-jd0,var1)%   end%   hold on% %   if ~isempty(var2(~isnan(var2)))%     plot(jd(i2)-jd0,var2,'r')%   end%   %   if ~isempty(var3(~isnan(var3)))%     plot(jd(i3)-jd0,var3,'g')%   end%   %   if ~isempty(var4(~isnan(var4)))%     plot(jd(i4)-jd0,var4,'--k','LineWidth', 0.2)%   end%  %   ylabel(str)%   grid on%   xlim([jdlim])%   datetick('x',12,'keeplimits')%       %   ok=1;% %   end